<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.liaoyuan.web.dao.IMarkerDao">

    <sql id="search">
        and createtime>=#{beginDate} AND  <![CDATA[createtime<=#{endDate}]]>
        <if test="numNo!=null and numNo!=''">
            and numNo like "%"#{numNo}"%"
        </if>
        <if test="settlement!=null and settlement!=''">
            and settlement like "%"#{settlement}"%"
        </if>
        <if test="name!=null and name!=''">
            and name like "%"#{name}"%"
        </if>
        <if test="status!=null and status!=''">
            and status =#{status}
        </if>
        <if test="contractType!=null and contractType!=''">
            and contractType = #{contractType}
        </if>
    </sql>
    <!--common -->
    <select id="countContractData" parameterType="ContractBean" resultType="java.lang.Integer">
        select count(*) from car_contract where 1=1
        <include refid="search"/>

    </select>
    <select id="getTableContractData" parameterType="ContractBean" resultType="ContractBean">
        select id,numNo,settlement,name,orderCount,unitPrice,orderCount*unitPrice as prepaidAmount,
        sendCount,orderCount-sendCount as leftCount,sendCount*unitPrice as sendPrice,
        orderCount*unitPrice-sendCount*unitPrice as leftPrice,inputPerson,usePerson,contractType,forkliftFee,
        orderTime,createtime,status,billName,address,billNo,tel,bankName,bankNo from car_contract
        where 1=1
        <include refid="search"/>
        order by createtime desc limit ${iDisplayStart},${iDisplayLength}
    </select>

    <insert id="addContractInfo" parameterType="ContractBean">
        insert into car_contract(numNo,settlement,name,orderCount,unitPrice,inputPerson,
        usePerson,contractType,forkliftFee,orderTime,status,billName,address,billNo,tel,bankName,bankNo) values (#{numNo},#{settlement},#{name},
        #{orderCount},#{unitPrice},#{inputPerson},#{usePerson},#{contractType},#{forkliftFee},
        #{orderTime},#{status},#{billName},#{address},#{billNo},#{tel},#{bankName},#{bankNo});
    </insert>
    <update id="editContractInfo" parameterType="ContractBean">
        update car_contract set numNo=#{numNo},settlement=#{settlement},name=#{name},
        orderCount=#{orderCount},unitPrice=#{unitPrice},inputPerson=#{inputPerson},
        usePerson=#{usePerson},contractType=#{contractType},
        forkliftFee=#{forkliftFee},orderTime=#{orderTime},status=#{status},
        billName=#{billName},address=#{address},billNo=#{billNo},tel=#{tel},
        bankName=#{bankName},bankNo=#{bankNo} where id=#{id}
    </update>

    <update id="lockInfo" parameterType="ContractBean">
        update car_contract set status=2 where id=#{id}
    </update>
    <update id="unlockInfo" parameterType="ContractBean">
        update car_contract set status=1 where id=#{id}
    </update>

    <delete id="deleteContractInfo">
        delete from car_contract where id=#{id}
    </delete>


    <!--外运查询-->
    <sql id="searchMonth">
        and createtime>=#{beginDate} AND  <![CDATA[createtime<=#{endDate}]]>
        
    </sql>
    <!--common -->
    <select id="countMonthPlanData" parameterType="PlanBean" resultType="java.lang.Integer">
        select count(*) from out_month_plan where 1=1
        <include refid="searchMonth"/>

    </select>
    <select id="getTableMonthPlanData" parameterType="PlanBean" resultType="PlanBean">
        select id,rid,settlement,name,planCarNum,actualCarNum,planTonnage,actualSendedTonnage,
        planCarNum-actualCarNum as unsendedCarNum,
        planTonnage-actualSendedTonnage as unsendedTonnage,
        actualUnitPrice,wellsName,coalName,siteName,privateLine,method,usePerson,inputPerson,
        payId,createtime,status from out_month_plan
        where 1=1
        <include refid="searchMonth"/>
        order by rid asc,createtime desc limit ${iDisplayStart},${iDisplayLength}
    </select>
    <insert id="addMonthPlan" parameterType="PlanBean">
        insert into out_month_plan (rid,name,planCarNum,actualCarNum,inputPerson,
        usePerson,planTonnage,actualSendedTonnage,actualUnitPrice,
        wellsName,coalName,siteName,privateLine,settlement,method,payId)
        values (#{rid},#{name},#{planCarNum},#{actualCarNum},#{inputPerson},#{usePerson},
        #{planTonnage},#{actualSendedTonnage},#{actualUnitPrice},
        #{wellsName},#{coalName},#{siteName},#{privateLine},#{settlement},#{method},#{payId});
    </insert>
    <update id="editMonthPlan" parameterType="PlanBean">
        update out_month_plan set rid=#{rid},name=#{name},planCarNum=#{planCarNum},
        actualCarNum=#{actualCarNum},usePerson=#{usePerson},planTonnage=#{planTonnage},
        usePerson=#{usePerson},actualSendedTonnage=#{actualSendedTonnage},
        actualUnitPrice=#{actualUnitPrice},wellsName=#{wellsName},
        coalName=#{coalName},siteName=#{siteName},privateLine=#{privateLine},settlement=#{settlement},
        method=#{method},payId=#{payId} where id=#{id}
    </update>
    <update id="stopMonthPlan">
        update out_month_plan set status=-1 where id=#{id}
    </update>
    <delete id="deleteMonthPlan">
        delete from out_month_plan where id=#{id}
    </delete>

    <!--根据月计划id查看相应的日计划  月计划终止的不显示-->
    <select id="countDayPlanData" parameterType="PlanBean" resultType="java.lang.Integer">
        select count(*) from out_day_plan d   where 1=1
        <choose>
            <when test="monthId!=null and monthId!=''">
                and d.month_id=#{monthId}
            </when>
            <otherwise>
               and d.createtime>=#{beginDate} AND  <![CDATA[d.createtime<=#{endDate}]]>
            </otherwise>
        </choose>
    </select>
    <select id="getTableDayPlanData" parameterType="PlanBean" resultType="PlanBean">
        select d.id,d.rid,d.settlement,d.name,d.planCarNum,d.actualCarNum,d.planTonnage,d.actualSendedTonnage,
        d.planCarNum-d.actualCarNum as unsendedCarNum,
        d.planTonnage-d.actualSendedTonnage as unsendedTonnage,
        d.actualUnitPrice,d.wellsName,d.coalName,d.siteName,d.privateLine,d.method,d.usePerson,d.inputPerson,
        d.payId,d.createtime,d.month_id as monthId from out_day_plan d
        where 1=1
       <choose>
            <when test="monthId!=null and monthId!=''">
                and d.month_id=#{monthId}
            </when>
            <otherwise>
               and d.createtime>=#{beginDate} AND  <![CDATA[d.createtime<=#{endDate}]]>
            </otherwise>
        </choose>
        order by d.createtime desc
        <!--limit ${iDisplayStart},${iDisplayLength}-->
    </select>

    <insert id="addDayPlan" parameterType="PlanBean">
        insert into out_day_plan (rid,name,planCarNum,actualCarNum,inputPerson,
        usePerson,planTonnage,actualSendedTonnage,actualUnitPrice,
        wellsName,coalName,siteName,privateLine,settlement,method,payId,month_id)
        values (#{rid},#{name},#{planCarNum},#{actualCarNum},#{inputPerson},#{usePerson},
        #{planTonnage},#{actualSendedTonnage},#{actualUnitPrice},
        #{wellsName},#{coalName},#{siteName},#{privateLine},#{settlement},#{method},#{payId},#{monthId});
    </insert>

    <update id="editDayPlan" parameterType="PlanBean">
        update out_day_plan set rid=#{rid},name=#{name},planCarNum=#{planCarNum},
        actualCarNum=#{actualCarNum},usePerson=#{usePerson},planTonnage=#{planTonnage},
        usePerson=#{usePerson},actualSendedTonnage=#{actualSendedTonnage},
        actualUnitPrice=#{actualUnitPrice},wellsName=#{wellsName},
        coalName=#{coalName},siteName=#{siteName},privateLine=#{privateLine},settlement=#{settlement},
        method=#{method},payId=#{payId} where id=#{id}
    </update>
    <delete id="deleteDayPlan">
        delete from out_day_plan where id=#{id}
    </delete>
</mapper>
